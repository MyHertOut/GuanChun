# 《宠魅：灵魂羁绊》数据库设计

## 1. 数据库选型

### 1.1 PostgreSQL 选择理由

| 特性 | 说明 | 优势 |
|------|------|------|
| **关系型数据库** | 支持 ACID 事务 | 数据一致性保证 |
| **JSON 类型支持** | 存储 JSON 数据 | 灵活存储配置数据 |
| **复杂查询** | 支持窗口函数、CTE | 复杂业务逻辑实现 |
| **索引优化** | 支持 B-Tree、GiST 等索引 | 查询性能优化 |
| **全文搜索** | 内置全文搜索 | 魂宠搜索功能 |
| **扩展性** | 支持分区、复制 | 横向扩展能力 |
| **开源免费** | PostgreSQL License | 无授权成本 |

### 1.2 数据库版本

- **PostgreSQL**: 16.x (LTS)
- **PostGIS**: 3.4.x (空间扩展，未来可能需要)
- **pgvector**: 0.5.x (向量搜索，AI推荐功能)

---

## 2. ER 图

### 2.1 实体关系图

```
┌─────────────────┐
│    players     │
├─────────────────┤
│ id (PK)       │
│ name          │
│ email         │
│ password_hash │
│ soul_power    │
│ max_soul_power│
│ level         │
│ gold          │
│ created_at    │
│ updated_at    │
└───────┬───────┘
        │ 1
        │
        │ N
┌───────┴─────────┐
│      pets       │
├─────────────────┤
│ uid (PK)       │
│ player_id (FK)  │
│ species_id (FK) │
│ nickname       │
│ level          │
│ exp            │
│ hp             │
│ max_hp         │
│ stamina        │
│ max_stamina    │
│ attack         │
│ defense        │
│ speed          │
│ learned_skills │
│ loyalty        │
│ mutation_points│
│ created_at     │
│ updated_at     │
└─────────────────┘

┌─────────────────┐      ┌─────────────────┐
│  pet_species   │      │    skills      │
├─────────────────┤      ├─────────────────┤
│ id (PK)        │      │ id (PK)        │
│ name           │      │ name           │
│ rank           │      │ element        │
│ elements       │      │ type           │
│ description    │      │ power          │
│ base_stats     │      │ cost           │
│ skills         │      │ accuracy       │
│ evolutions     │      │ description    │
│ created_at     │      │ effect         │
└─────────────────┘      │ created_at     │
                         └─────────────────┘

┌─────────────────┐
│     saves      │
├─────────────────┤
│ id (PK)        │
│ player_id (FK)  │
│ save_name      │
│ save_data      │
│ created_at     │
└─────────────────┘

┌─────────────────┐
│    items       │
├─────────────────┤
│ id (PK)        │
│ name           │
│ type           │
│ effect         │
│ value          │
│ description    │
│ created_at     │
└─────────────────┘

┌─────────────────┐      ┌─────────────────┐
│  battles      │      │  battle_logs   │
├─────────────────┤      ├─────────────────┤
│ id (PK)        │      │ id (PK)        │
│ player_id (FK)  │      │ battle_id (FK) │
│ player_pet_uid  │      │ round          │
│ enemy_pet_uid  │      │ source         │
│ status         │      │ type           │
│ winner         │      │ message        │
│ round          │      │ value          │
│ environment    │      │ timestamp      │
│ created_at     │      └─────────────────┘
└─────────────────┘
```

---

## 3. 表设计

### 3.1 玩家表 (players)

#### 3.1.1 表结构

```sql
CREATE TABLE players (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255),
  soul_power INT NOT NULL DEFAULT 100,
  max_soul_power INT NOT NULL DEFAULT 100,
  level VARCHAR(20) NOT NULL DEFAULT '魂徒',
  gold INT NOT NULL DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  CHECK (soul_power >= 0 AND soul_power <= max_soul_power),
  CHECK (gold >= 0)
);
```

#### 3.1.2 字段说明

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| `id` | VARCHAR(36) | 唯一标识符 | PK, UUID |
| `name` | VARCHAR(50) | 玩家昵称 | UNIQUE, NOT NULL |
| `email` | VARCHAR(100) | 邮箱 | UNIQUE |
| `password_hash` | VARCHAR(255) | 密码哈希 | bcrypt |
| `soul_power` | INT | 当前魂力 | >= 0 |
| `max_soul_power` | INT | 最大魂力 | > 0 |
| `level` | VARCHAR(20) | 魂念等级 | 魂徒~魂尊 |
| `gold` | INT | 金币 | >= 0 |
| `created_at` | TIMESTAMP | 创建时间 | 自动 |
| `updated_at` | TIMESTAMP | 更新时间 | 自动更新 |

#### 3.1.3 索引

```sql
CREATE INDEX idx_players_email ON players(email);
CREATE INDEX idx_players_level ON players(level);
CREATE INDEX idx_players_created ON players(created_at);
```

---

### 3.2 魂宠表 (pets)

#### 3.2.1 表结构

```sql
CREATE TABLE pets (
  uid VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  player_id VARCHAR(36) NOT NULL,
  species_id VARCHAR(10) NOT NULL,
  nickname VARCHAR(50),
  level INT NOT NULL DEFAULT 1,
  exp INT NOT NULL DEFAULT 0,
  hp INT NOT NULL,
  max_hp INT NOT NULL,
  stamina INT NOT NULL,
  max_stamina INT NOT NULL,
  attack INT NOT NULL,
  defense INT NOT NULL,
  speed INT NOT NULL,
  learned_skills JSONB DEFAULT '[]',
  loyalty INT NOT NULL DEFAULT 80,
  mutation_points INT NOT NULL DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE,

  CHECK (level >= 1 AND level <= 100),
  CHECK (exp >= 0),
  CHECK (hp >= 0 AND hp <= max_hp),
  CHECK (stamina >= 0 AND stamina <= max_stamina),
  CHECK (loyalty >= 0 AND loyalty <= 100),
  CHECK (mutation_points >= 0)
);
```

#### 3.2.2 字段说明

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| `uid` | VARCHAR(36) | 魂宠唯一ID | PK, UUID |
| `player_id` | VARCHAR(36) | 所属玩家ID | FK |
| `species_id` | VARCHAR(10) | 品种ID | FK |
| `nickname` | VARCHAR(50) | 昵称 | |
| `level` | INT | 等级 | 1-100 |
| `exp` | INT | 经验值 | >= 0 |
| `hp` | INT | 当前HP | >= max_hp |
| `max_hp` | INT | 最大HP | > 0 |
| `stamina` | INT | 当前体力 | >= max_stamina |
| `max_stamina` | INT | 最大体力 | > 0 |
| `attack` | INT | 攻击力 | > 0 |
| `defense` | INT | 防御力 | > 0 |
| `speed` | INT | 速度 | > 0 |
| `learned_skills` | JSONB | 已学技能 | Array |
| `loyalty` | INT | 忠诚度 | 0-100 |
| `mutation_points` | INT | 异变积分 | >= 0 |

#### 3.2.3 JSONB 示例

```json
// learned_skills
["S001", "S003", "S005"]
```

#### 3.2.4 索引

```sql
CREATE INDEX idx_pets_player ON pets(player_id);
CREATE INDEX idx_pets_species ON pets(species_id);
CREATE INDEX idx_pets_level ON pets(level);
CREATE INDEX idx_pets_created ON pets(created_at);
CREATE INDEX idx_pets_skills ON pets USING gin (learned_skills);
```

---

### 3.3 魂宠品种表 (pet_species)

#### 3.3.1 表结构

```sql
CREATE TABLE pet_species (
  id VARCHAR(10) PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  rank VARCHAR(20) NOT NULL,
  elements JSONB NOT NULL,
  description TEXT,
  base_stats JSONB NOT NULL,
  skills JSONB NOT NULL,
  evolutions JSONB DEFAULT '[]',
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.3.2 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | VARCHAR(10) | 品种ID |
| `name` | VARCHAR(50) | 品种名称 |
| `rank` | VARCHAR(20) | 种族等级 |
| `elements` | JSONB | 属性列表 |
| `description` | TEXT | 描述 |
| `base_stats` | JSONB | 基础属性 |
| `skills` | JSONB | 技能池 |
| `evolutions` | JSONB | 进化路径 |

#### 3.3.3 JSONB 示例

```json
// elements
["妖灵", "火"]

// base_stats
{
  "health": 60,
  "stamina": 80,
  "attack": 15,
  "defense": 10,
  "speed": 25
}

// skills
[
  {
    "learn_level": 1,
    "skill_id": "S001",
    "name": "月光"
  }
]

// evolutions
[
  {
    "target_id": "1002",
    "type": "evolution",
    "condition": {
      "min_level": 20,
      "description": "正常成长进化"
    }
  }
]
```

#### 3.3.4 索引

```sql
CREATE INDEX idx_species_rank ON pet_species(rank);
CREATE INDEX idx_species_elements ON pet_species USING gin (elements);
```

---

### 3.4 技能表 (skills)

#### 3.4.1 表结构

```sql
CREATE TABLE skills (
  id VARCHAR(10) PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  element VARCHAR(20) NOT NULL,
  type VARCHAR(20) NOT NULL,
  power INT NOT NULL DEFAULT 0,
  cost INT NOT NULL DEFAULT 10,
  accuracy INT NOT NULL DEFAULT 100,
  description TEXT,
  effect JSONB,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  CHECK (power >= 0),
  CHECK (cost >= 0),
  CHECK (accuracy >= 0 AND accuracy <= 100)
);
```

#### 3.4.2 字段说明

| 字段 | 类型 | 说明 | 约束 |
|------|------|------|------|
| `id` | VARCHAR(10) | 技能ID | PK |
| `name` | VARCHAR(50) | 技能名称 | NOT NULL |
| `element` | VARCHAR(20) | 技能属性 | NOT NULL |
| `type` | VARCHAR(20) | 技能类型 | NOT NULL |
| `power` | INT | 威力 | >= 0 |
| `cost` | INT | 消耗 | >= 0 |
| `accuracy` | INT | 命中率 | 0-100 |
| `description` | TEXT | 描述 | |
| `effect` | JSONB | 效果 | |

#### 3.4.3 JSONB 示例

```json
// effect
{
  "type": "damage",
  "value": 1.5,
  "status_type": "burn",
  "duration": 3
}
```

#### 3.4.4 索引

```sql
CREATE INDEX idx_skills_element ON skills(element);
CREATE INDEX idx_skills_type ON skills(type);
```

---

### 3.5 存档表 (saves)

#### 3.5.1 表结构

```sql
CREATE TABLE saves (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  player_id VARCHAR(36) NOT NULL,
  save_name VARCHAR(100),
  save_data JSONB NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE
);
```

#### 3.5.2 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | VARCHAR(36) | 存档ID | PK |
| `player_id` | VARCHAR(36) | 玩家ID | FK |
| `save_name` | VARCHAR(100) | 存档名称 | |
| `save_data` | JSONB | 存档数据 | |
| `created_at` | TIMESTAMP | 创建时间 | |

#### 3.5.3 JSONB 示例

```json
// save_data
{
  "player": {
    "id": "player-123",
    "name": "楚暮",
    "soul_power": 100,
    "level": "魂士"
  },
  "pets": [
    {
      "uid": "pet-456",
      "species_id": "1001",
      "level": 5,
      "exp": 500
    }
  ],
  "inventory": [
    {
      "item_id": "item-789",
      "quantity": 10
    }
  ],
  "progress": {
    "current_map": "新月之地",
    "completed_quests": ["quest-1"]
  }
}
```

#### 3.5.4 索引

```sql
CREATE INDEX idx_saves_player ON saves(player_id);
CREATE INDEX idx_saves_created ON saves(created_at);
```

---

### 3.6 物品表 (items)

#### 3.6.1 表结构

```sql
CREATE TABLE items (
  id VARCHAR(10) PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  type VARCHAR(20) NOT NULL,
  effect JSONB,
  value INT NOT NULL DEFAULT 0,
  description TEXT,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.6.2 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | VARCHAR(10) | 物品ID | PK |
| `name` | VARCHAR(50) | 物品名称 |
| `type` | VARCHAR(20) | 物品类型 |
| `effect` | JSONB | 物品效果 |
| `value` | INT | 物品价值 |
| `description` | TEXT | 物品描述 |

---

### 3.7 战斗表 (battles)

#### 3.7.1 表结构

```sql
CREATE TABLE battles (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  player_id VARCHAR(36) NOT NULL,
  player_pet_uid VARCHAR(36) NOT NULL,
  enemy_pet_uid VARCHAR(36) NOT NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'active',
  winner VARCHAR(20),
  round INT NOT NULL DEFAULT 0,
  environment VARCHAR(50),
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (player_id) REFERENCES players(id)
);
```

#### 3.7.2 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | VARCHAR(36) | 战斗ID | PK |
| `player_id` | VARCHAR(36) | 玩家ID | FK |
| `player_pet_uid` | VARCHAR(36) | 玩家魂宠 | FK |
| `enemy_pet_uid` | VARCHAR(36) | 敌方魂宠 | |
| `status` | VARCHAR(20) | 战斗状态 | active/finished |
| `winner` | VARCHAR(20) | 胜者 | player/enemy |
| `round` | INT | 当前回合 | |
| `environment` | VARCHAR(50) | 战斗环境 | |

---

### 3.8 战斗日志表 (battle_logs)

#### 3.8.1 表结构

```sql
CREATE TABLE battle_logs (
  id VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid(),
  battle_id VARCHAR(36) NOT NULL,
  round INT NOT NULL,
  source VARCHAR(20) NOT NULL,
  type VARCHAR(20) NOT NULL,
  message TEXT NOT NULL,
  value INT,
  timestamp TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (battle_id) REFERENCES battles(id) ON DELETE CASCADE
);
```

#### 3.8.2 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | VARCHAR(36) | 日志ID | PK |
| `battle_id` | VARCHAR(36) | 战斗ID | FK |
| `round` | INT | 回合数 | |
| `source` | VARCHAR(20) | 来源 | player/enemy/system |
| `type` | VARCHAR(20) | 类型 | attack/skill/damage/heal |
| `message` | TEXT | 日志消息 | |
| `value` | INT | 数值 | 伤害/治疗等 |
| `timestamp` | TIMESTAMP | 时间戳 | |

---

## 4. 数据库优化

### 4.1 索引策略

#### 4.1.1 索引类型选择

| 索引类型 | 使用场景 | 示例 |
|---------|---------|------|
| B-Tree | 等值查询、范围查询 | `WHERE level = 10` |
| GiN | JSONB 数据查询 | `WHERE learned_skills @> '["S001"]'` |
| GiST | 范围查询、全文搜索 | `WHERE description @@ to_tsquery('月光')` |

#### 4.1.2 复合索引

```sql
-- 玩家查询魂宠（常用）
CREATE INDEX idx_pets_player_level ON pets(player_id, level);

-- 战斗日志查询
CREATE INDEX idx_logs_battle_round ON battle_logs(battle_id, round);
```

### 4.2 分区策略

#### 4.2.1 战斗日志按时间分区

```sql
CREATE TABLE battle_logs (
  id VARCHAR(36),
  battle_id VARCHAR(36),
  round INT,
  source VARCHAR(20),
  type VARCHAR(20),
  message TEXT,
  value INT,
  timestamp TIMESTAMP
) PARTITION BY RANGE (timestamp);

-- 创建月度分区
CREATE TABLE battle_logs_2026_01 PARTITION OF battle_logs
  FOR VALUES FROM ('2026-01-01') TO ('2026-02-01');
```

### 4.3 查询优化

#### 4.3.1 使用 EXPLAIN 分析

```sql
EXPLAIN ANALYZE
SELECT * FROM pets
WHERE player_id = 'player-123'
  AND level BETWEEN 5 AND 10;
```

#### 4.3.2 避免全表扫描

```sql
-- ✅ 使用索引
SELECT * FROM pets
WHERE player_id = 'player-123'
ORDER BY created_at DESC
LIMIT 10;

-- ❌ 全表扫描
SELECT * FROM pets
WHERE LOWER(name) LIKE '%月%';
```

---

## 5. 数据迁移

### 5.1 初始化数据

#### 5.1.1 导入魂宠品种数据

```sql
-- 从 JSON 文件导入
COPY pet_species(id, name, rank, elements, description, base_stats, skills)
FROM '/path/to/soul_pets.json'
WITH (FORMAT json);
```

#### 5.1.2 导入技能数据

```sql
-- 从 JSON 文件导入
COPY skills(id, name, element, type, power, cost, description)
FROM '/path/to/skills.json'
WITH (FORMAT json);
```

### 5.2 版本控制

#### 5.2.1 数据库版本表

```sql
CREATE TABLE schema_version (
  version VARCHAR(20) PRIMARY KEY,
  description TEXT,
  applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 初始化版本
INSERT INTO schema_version (version, description)
VALUES ('v1.0', '初始数据库结构');
```

#### 5.2.2 迁移脚本

```sql
-- v1.1 迁移脚本
-- 新增字段
ALTER TABLE pets ADD COLUMN "mutated_from" VARCHAR(10);

-- 更新版本
INSERT INTO schema_version (version, description)
VALUES ('v1.1', '新增异变来源字段');
```

---

## 6. 备份与恢复

### 6.1 备份策略

#### 6.1.1 逻辑备份 (pg_dump)

```bash
# 完整备份
pg_dump -U postgres -d soul_pets -f backup_$(date +%Y%m%d).sql

# 仅备份结构
pg_dump -U postgres -d soul_pets -s -f schema.sql

# 仅备份数据
pg_dump -U postgres -d soul_pets -a -f data.sql
```

#### 6.1.2 物理备份 (pg_basebackup)

```bash
# 基础备份
pg_basebackup -U postgres -D /var/lib/postgresql/backup -Ft -z -P
```

### 6.2 定时备份

#### 6.2.1 Cron 任务

```bash
# 每天凌晨2点备份
0 2 * * * pg_dump -U postgres -d soul_pets | gzip > /backup/soul_pets_$(date +\%Y\%m\%d).sql.gz
```

### 6.3 恢复操作

```bash
# 恢复备份
psql -U postgres -d soul_pets < backup_20260104.sql

# 或使用 gunzip
gunzip < backup_20260104.sql.gz | psql -U postgres -d soul_pets
```

---

## 7. 安全性

### 7.1 访问控制

#### 7.1.1 创建应用用户

```sql
-- 创建只读用户
CREATE USER readonly_user WITH PASSWORD 'secure_password';
GRANT CONNECT ON DATABASE soul_pets TO readonly_user;
GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;

-- 创建读写用户
CREATE USER app_user WITH PASSWORD 'secure_password';
GRANT CONNECT ON DATABASE soul_pets TO app_user;
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO app_user;
```

### 7.2 数据加密

#### 7.2.1 密码加密

```sql
-- 使用 bcrypt 或 Argon2
-- 在应用层加密后存储
INSERT INTO players (name, password_hash)
VALUES ('player1', '$2b$12$LQv3c1yqBWVHxkd0LHAkKOYW/wGHcQWJQJNQ1aH0');
```

---

## 8. 性能监控

### 8.1 慢查询日志

```sql
-- 配置慢查询阈值 (单位: 毫秒)
ALTER DATABASE soul_pets SET log_min_duration_statement = 1000;
```

### 8.2 查询统计

```sql
-- 查看表大小
SELECT
  relname AS table_name,
  pg_size_pretty(pg_total_relation_size(relid)) AS size
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC;

-- 查看索引使用情况
SELECT
  schemaname,
  tablename,
  indexname,
  idx_scan,
  idx_tup_read
FROM pg_stat_user_indexes
ORDER BY idx_scan ASC;
```

---

## 9. 数据清理

### 9.1 定期清理

```sql
-- 清理过期战斗日志（保留30天）
DELETE FROM battle_logs
WHERE timestamp < NOW() - INTERVAL '30 days';

-- 清理过期存档（保留10个）
DELETE FROM saves
WHERE id NOT IN (
  SELECT id FROM saves
  WHERE player_id = saves.player_id
  ORDER BY created_at DESC
  LIMIT 10
);
```

### 9.2 自动清理

```sql
-- 创建清理函数
CREATE OR REPLACE FUNCTION cleanup_old_data()
RETURNS void AS $$
BEGIN
  -- 清理过期数据
  DELETE FROM battle_logs WHERE timestamp < NOW() - INTERVAL '30 days';
END;
$$ LANGUAGE plpgsql;

-- 创建定时任务（使用 pg_cron）
SELECT cron.schedule(
  'cleanup-old-data',
  '0 3 * * *',
  'SELECT cleanup_old_data()'
);
```

---

**文档版本**: v1.0
**创建日期**: 2026-01-04
**维护人员**: 后端团队
**数据库**: PostgreSQL 16.x
