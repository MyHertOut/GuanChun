# 《宠魅：灵魂羁绊》系统架构设计

## 1. 架构概述

### 1.1 架构原则

采用**前后端分离架构**，遵循以下设计原则：

- **职责分离**: 前端负责展示和交互，后端负责业务逻辑和数据处理
- **高内聚低耦合**: 模块内部高内聚，模块之间低耦合
- **可扩展性**: 系统支持横向扩展和纵向扩展
- **可维护性**: 代码结构清晰，易于理解和维护
- **性能优先**: 前端体验优先，后端性能优化

### 1.2 整体架构图

```
┌─────────────────────────────────────────────────────────┐
│                    客户端 (浏览器)                    │
│  ┌─────────────────────────────────────────────────┐  │
│  │         Vue 3 单页应用 (SPA)                  │  │
│  │  ┌─────────┐  ┌──────────┐  ┌───────────┐ │  │
│  │  │ 组件层  │  │ 状态管理 │  │   路由    │ │  │
│  │  └────┬────┘  └────┬─────┘  └─────┬─────┘ │  │
│  │       └───────────────┼────────────┘        │  │
│  │                      ▼                     │  │
│  │  ┌─────────────────────────────┐         │  │
│  │  │      Axios HTTP 客户端      │         │  │
│  │  └──────────────┬──────────────┘         │  │
│  └─────────────────┼──────────────────────────┘  │
│                    │ HTTPS                       │
└────────────────────┼──────────────────────────────┘
                     │
┌────────────────────┼──────────────────────────────┐
│                    ▼                              │
│  ┌──────────────────────────────────────────────┐  │
│  │        API 网关 (Nginx / 反向代理)        │  │
│  │    - 静态资源服务                          │  │
│  │    - 路由转发                              │  │
│  │    - 负载均衡                              │  │
│  │    - SSL 终止                              │  │
│  └──────────────────┬─────────────────────────┘  │
│                     │                             │
│  ┌──────────────────┴─────────────────────────┐  │
│  │         后端服务 (Node.js + Express)       │  │
│  │  ┌─────────┐  ┌──────────┐  ┌──────────┐ │  │
│  │  │ 控制器  │  │ 服务层   │  │  数据层  │ │  │
│  │  │(Controller) │ │(Service)  │ │(Repository)│ │  │
│  │  └────┬────┘  └────┬─────┘  └────┬─────┘ │  │
│  └───────┼────────────┼────────────┼─────────┘  │
│          │            │            │             │
│  ┌───────┴────┐  ┌───┴────────┐  ┌─┴─────────┐ │
│  │ 认证中间件│  │ 验证中间件│  │ 日志中间件│ │
│  └───────────┘  └───────────┘  └───────────┘ │
└────────────────────┼──────────────────────────────┘
                     │
┌────────────────────┼──────────────────────────────┐
│                    ▼                              │
│  ┌──────────────────────────────────────────────┐  │
│  │         数据库 (PostgreSQL)                │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐│  │
│  │  │ 玩家表   │  │ 魂宠表   │  │ 技能表   ││  │
│  │  │ (players)│  │  (pets)  │  │(skills)  ││  │
│  │  └──────────┘  └──────────┘  └──────────┘│  │
│  │  ┌──────────┐  ┌──────────┐              │  │
│  │  │ 存档表   │  │ 物品表   │              │  │
│  │  │ (saves)  │  │(items)   │              │  │
│  │  └──────────┘  └──────────┘              │  │
│  └──────────────────────────────────────────────┘  │
│                                                 │
│  ┌──────────────────────────────────────────────┐  │
│  │        缓存层 (Redis)                     │  │
│  │    - Session 存储                          │  │
│  │    - 热点数据缓存                          │  │
│  │    - 排行榜缓存                            │  │
│  └──────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────┘
```

---

## 2. 前端架构设计

### 2.1 技术选型

| 技术栈 | 选型 | 理由 |
|-------|------|------|
| 核心框架 | Vue 3.5 | 组合式API，性能优异，生态完善 |
| 构建工具 | Vite 7.2 | 开发体验好，构建速度快 |
| 语言 | TypeScript 5.x | 类型安全，提升开发效率 |
| UI库 | TailwindCSS 3.4 | 原子化CSS，开发效率高 |
| 状态管理 | Pinia 3.x | Vue 3官方推荐，轻量级 |
| 路由 | Vue Router 4.x | Vue 3官方路由 |
| HTTP客户端 | Axios 1.x | 功能强大，拦截器完善 |
| 工具库 | Lodash-es, Day.js | 常用工具函数 |

### 2.2 前端分层架构

```
┌─────────────────────────────────────────┐
│         视图层 (Views)                │
│   - Home.vue                         │
│   - Battle.vue                       │
│   - PetManagement.vue                │
└────────────┬────────────────────────────┘
             │
┌────────────┼────────────────────────────┐
│             ▼                          │
│      组件层 (Components)              │
│   - 业务组件 (Battle, Pet, Player)   │
│   - 通用组件 (Button, Modal, Toast)  │
└────────────┬────────────────────────────┘
             │
┌────────────┼────────────────────────────┐
│             ▼                          │
│     逻辑层 (Composables)             │
│   - useBattle                       │
│   - usePet                          │
│   - usePlayer                       │
└────────────┬────────────────────────────┘
             │
┌────────────┼────────────────────────────┐
│             ▼                          │
│      状态层 (Stores)                 │
│   - battle.ts                       │
│   - pet.ts                          │
│   - player.ts                       │
└────────────┬────────────────────────────┘
             │
┌────────────┼────────────────────────────┐
│             ▼                          │
│      数据层 (API)                    │
│   - battle.ts                       │
│   - pet.ts                          │
│   - player.ts                       │
└───────────────────────────────────────┘
```

### 2.3 关键设计决策

#### 2.3.1 使用 Composition API 而非 Options API
**理由**:
- 更好的 TypeScript 支持
- 逻辑复用更方便（Composables）
- 代码组织更灵活

#### 2.3.2 使用 Pinia 而非 Vuex
**理由**:
- 对 TypeScript 支持更好
- API 更简洁，样板代码更少
- 模块化设计，无需命名空间

#### 2.3.3 使用 Vite 而非 Webpack
**理由**:
- 开发服务器启动更快（毫秒级）
- HMR 热更新速度极快
- 配置更简单，开箱即用

#### 2.3.4 使用 TailwindCSS 而非 CSS 预处理器
**理由**:
- 不需要离开 HTML 编写样式
- 响应式设计更简单
- 减少自定义 CSS 代码量

---

## 3. 后端架构设计

### 3.1 技术选型

| 技术栈 | 选型 | 理由 |
|-------|------|------|
| 运行时 | Node.js 20 LTS | 与前端技术栈统一 |
| Web框架 | Express 4.x | 轻量级，生态完善 |
| ORM | Prisma 5.x | 类型安全，开发体验好 |
| 数据库 | PostgreSQL 16 | 关系型数据库，功能强大 |
| 缓存 | Redis 7.x | 性能优异，数据结构丰富 |
| 认证 | JWT | 无状态，可扩展 |

### 3.2 后端分层架构

```
┌─────────────────────────────────────────┐
│      控制器层 (Controllers)          │
│   - 接收HTTP请求                     │
│   - 参数验证                         │
│   - 返回HTTP响应                     │
└────────────┬────────────────────────────┘
             │
┌────────────┼────────────────────────────┐
│             ▼                          │
│      服务层 (Services)                │
│   - 业务逻辑实现                      │
│   - 事务管理                         │
│   - 数据转换                         │
└────────────┬────────────────────────────┘
             │
┌────────────┼────────────────────────────┐
│             ▼                          │
│      数据层 (Repositories)            │
│   - 数据库操作                        │
│   - 查询构建                         │
│   - 缓存策略                         │
└────────────┬────────────────────────────┘
             │
┌────────────┼────────────────────────────┐
│             ▼                          │
│    数据库层 (Database)                │
│   - PostgreSQL                      │
│   - Redis                          │
└───────────────────────────────────────┘
```

### 3.3 中间件设计

```
请求流程:
Client → 认证 → 日志 → 限流 → 参数验证 → 控制器 → 服务 → 数据 → 响应
                      ↓                ↓
                  错误处理 ←─────────┘
```

**中间件列表**:
1. **认证中间件**: JWT Token 验证
2. **日志中间件**: 记录请求日志
3. **限流中间件**: 防止 API 滥用
4. **参数验证中间件**: 使用 Zod 验证参数
5. **错误处理中间件**: 统一错误处理

---

## 4. 数据库设计

### 4.1 数据库选型

**PostgreSQL** 的选择理由：
- 功能强大，支持复杂查询
- 支持 JSON 类型，适合存储配置数据
- 支持事务，保证数据一致性
- 支持索引，查询性能好
- 开源免费，社区活跃

### 4.2 核心表设计

#### 4.2.1 玩家表 (players)
```sql
CREATE TABLE players (
  id VARCHAR(36) PRIMARY KEY DEFAULT UUID(),
  name VARCHAR(50) NOT NULL UNIQUE,
  email VARCHAR(100) UNIQUE,
  password_hash VARCHAR(255),
  soul_power INT NOT NULL DEFAULT 100,
  max_soul_power INT NOT NULL DEFAULT 100,
  level VARCHAR(20) NOT NULL DEFAULT '魂徒',
  gold INT NOT NULL DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_level (level),
  INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.2 魂宠表 (pets)
```sql
CREATE TABLE pets (
  uid VARCHAR(36) PRIMARY KEY DEFAULT UUID(),
  player_id VARCHAR(36) NOT NULL,
  species_id VARCHAR(10) NOT NULL,
  nickname VARCHAR(50),
  level INT NOT NULL DEFAULT 1,
  exp INT NOT NULL DEFAULT 0,
  hp INT NOT NULL,
  max_hp INT NOT NULL,
  stamina INT NOT NULL,
  max_stamina INT NOT NULL,
  attack INT NOT NULL,
  defense INT NOT NULL,
  speed INT NOT NULL,
  learned_skills JSON,
  loyalty INT NOT NULL DEFAULT 80,
  mutation_points INT NOT NULL DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE,
  INDEX idx_player (player_id),
  INDEX idx_species (species_id),
  INDEX idx_level (level)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.3 魂宠品种表 (pet_species)
```sql
CREATE TABLE pet_species (
  id VARCHAR(10) PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  rank VARCHAR(20) NOT NULL,
  elements JSON NOT NULL,
  description TEXT,
  base_stats JSON NOT NULL,
  skills JSON NOT NULL,
  evolutions JSON,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_rank (rank),
  INDEX idx_elements ((elements->'$[0]'))
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.4 技能表 (skills)
```sql
CREATE TABLE skills (
  id VARCHAR(10) PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  element VARCHAR(20) NOT NULL,
  type VARCHAR(20) NOT NULL,
  power INT NOT NULL DEFAULT 0,
  cost INT NOT NULL DEFAULT 10,
  accuracy INT NOT NULL DEFAULT 100,
  description TEXT,
  effect JSON,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_element (element),
  INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 4.2.5 存档表 (saves)
```sql
CREATE TABLE saves (
  id VARCHAR(36) PRIMARY KEY DEFAULT UUID(),
  player_id VARCHAR(36) NOT NULL,
  save_name VARCHAR(100),
  save_data JSON NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (player_id) REFERENCES players(id) ON DELETE CASCADE,
  INDEX idx_player (player_id),
  INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### 4.3 索引策略

- **主键索引**: 所有表都有主键索引
- **外键索引**: 所有外键字段建立索引
- **查询索引**: 常用查询字段建立索引
- **复合索引**: 多字段联合查询建立复合索引

---

## 5. API 设计原则

### 5.1 RESTful API 规范

#### 5.1.1 URL 设计规则
- 使用名词复数形式: `/api/pets`
- 使用小写字母和连字符: `/api/soul-pets`
- 层级关系使用路径: `/api/players/:id/pets`

#### 5.1.2 HTTP 方法规范
- **GET**: 获取资源
- **POST**: 创建资源
- **PUT**: 完整更新资源
- **PATCH**: 部分更新资源
- **DELETE**: 删除资源

#### 5.1.3 响应状态码
- **200 OK**: 请求成功
- **201 Created**: 资源创建成功
- **400 Bad Request**: 请求参数错误
- **401 Unauthorized**: 未认证
- **403 Forbidden**: 无权限
- **404 Not Found**: 资源不存在
- **500 Internal Server Error**: 服务器错误

### 5.2 API 响应格式

#### 5.2.1 成功响应
```json
{
  "success": true,
  "data": { /* 实际数据 */ },
  "message": "操作成功"
}
```

#### 5.2.2 错误响应
```json
{
  "success": false,
  "error": {
    "code": "INVALID_PARAMS",
    "message": "参数验证失败",
    "details": { /* 详细错误信息 */ }
  }
}
```

### 5.3 分页设计
```json
{
  "success": true,
  "data": {
    "items": [ /* 数据列表 */ ],
    "pagination": {
      "page": 1,
      "pageSize": 20,
      "total": 100,
      "totalPages": 5
    }
  }
}
```

---

## 6. 缓存策略

### 6.1 Redis 使用场景

| 场景 | 缓存键 | 过期时间 | 策略 |
|------|--------|----------|------|
| Session | `session:{userId}` | 7天 | 惰性删除 |
| 玩家信息 | `player:{userId}` | 1小时 | 主动更新 |
| 魂宠品种 | `pet:species:{id}` | 永久 | 手动清除 |
| 战斗状态 | `battle:{battleId}` | 1小时 | 自动过期 |
| 排行榜 | `rank:{type}` | 10分钟 | 定时更新 |

### 6.2 缓存更新策略

- **写穿透**: 先更新数据库，再删除缓存
- **读穿透**: 缓存不存在时从数据库读取并写入缓存
- **缓存预热**: 系统启动时预加载热点数据

---

## 7. 安全设计

### 7.1 认证与授权

#### 7.1.1 JWT 认证流程
```
1. 用户登录 → 验证账号密码
2. 生成 JWT Token (包含 userId, role, exp)
3. 返回 Token 给客户端
4. 客户端每次请求携带 Token
5. 后端中间件验证 Token 有效性
```

#### 7.1.2 Token 结构
```json
{
  "header": {
    "alg": "HS256",
    "typ": "JWT"
  },
  "payload": {
    "userId": "user-123",
    "role": "player",
    "exp": 1704067200
  }
}
```

### 7.2 数据安全

- **密码加密**: 使用 bcrypt 加密存储
- **SQL注入防护**: 使用参数化查询
- **XSS防护**: 前端输入验证 + CSP策略
- **CSRF防护**: CSRF Token + SameSite Cookie

### 7.3 限流策略

- **IP限流**: 同一IP每分钟最多100次请求
- **用户限流**: 同一用户每分钟最多60次请求
- **API限流**: 单个API每秒最多10次请求

---

## 8. 性能优化

### 8.1 前端优化

| 优化项 | 方案 | 预期效果 |
|--------|------|----------|
| 代码分割 | 路由懒加载 | 减少首屏体积 |
| 图片优化 | WebP格式 + 懒加载 | 减少带宽 |
| 缓存策略 | Service Worker | 离线可用 |
| CDN加速 | 静态资源CDN | 加快加载 |
| 虚拟滚动 | 长列表优化 | 提升渲染性能 |

### 8.2 后端优化

| 优化项 | 方案 | 预期效果 |
|--------|------|----------|
| 数据库索引 | 合理建立索引 | 提升查询速度 |
| 查询优化 | 避免 N+1 查询 | 减少数据库压力 |
| 连接池 | pgBouncer | 提高连接复用 |
| 缓存 | Redis 缓存热点数据 | 减少数据库访问 |
| 压缩 | Gzip/Brotli 压缩 | 减少传输体积 |

---

## 9. 部署架构

### 9.1 部署方案

```
┌─────────────────────────────────────┐
│         负载均衡 (Nginx)         │
│  - SSL 终止                       │
│  - 静态资源服务                   │
│  - 反向代理                       │
└──────┬────────────┬──────────────┘
       │            │
  ┌────┴────┐  ┌──┴────────┐
  │ 前端服务器│  │ 后端服务器│
  │ (Vite)   │  │ (Node.js) │
  └───────────┘  └─────┬──────┘
                      │
            ┌─────────┴─────────┐
            │    数据库        │
            │  MySQL          │
            └─────────────────┘
```

### 9.2 容器化部署

使用 Docker 容器化部署，包含：
- **Frontend**: Nginx + 静态文件
- **Backend**: Node.js + Express
- **Database**: PostgreSQL
- **Cache**: Redis

---

## 10. 监控与日志

### 10.1 日志系统

| 日志类型 | 日志级别 | 存储位置 | 保留时间 |
|---------|---------|----------|----------|
| 访问日志 | INFO | 文件 | 30天 |
| 错误日志 | ERROR | 文件 + 数据库 | 永久 |
| 慢查询日志 | WARN | 文件 | 7天 |
| 业务日志 | INFO | 文件 | 30天 |

### 10.2 监控指标

- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: QPS、响应时间、错误率
- **数据库指标**: 连接数、慢查询、锁等待
- **缓存指标**: 命中率、内存使用、键数量

---

**文档版本**: v1.0
**创建日期**: 2026-01-04
**维护人员**: 架构团队
